<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup Your Booking Page</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    select, input[type="time"] {
      width: 100%;
      padding: 0.625rem 0.75rem;
      font-size: 0.9375rem;
      font-family: inherit;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      background: var(--color-surface);
      color: var(--color-text);
      line-height: 1.6;
    }
    select:focus, input[type="time"]:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="confirmation">
        <div class="check-icon">&#10003;</div>
        <h2>Calendar Connected</h2>
      </div>
    </div>

    <div class="card">
      <h2>Availability</h2>
      <div class="form-group">
        <label for="tz">Timezone</label>
        <select id="tz"></select>
      </div>
      <div style="display:flex;gap:0.75rem">
        <div class="form-group" style="flex:1">
          <label for="bhStart">Start time</label>
          <input type="time" id="bhStart" value="09:00" />
        </div>
        <div class="form-group" style="flex:1">
          <label for="bhEnd">End time</label>
          <input type="time" id="bhEnd" value="17:00" />
        </div>
      </div>
      <div class="form-group">
        <label for="slotDur">Meeting duration</label>
        <select id="slotDur">
          <option value="15">15 minutes</option>
          <option value="30" selected>30 minutes</option>
          <option value="45">45 minutes</option>
          <option value="60">60 minutes</option>
        </select>
      </div>
      <button class="btn btn-primary" id="saveBtn">Save Settings</button>
      <div id="statusMsg" class="status-msg success hidden" style="margin-top:0.75rem"></div>
    </div>

    <div class="card">
      <h2>Your Booking Link</h2>
      <div class="form-group">
        <input type="text" id="bookingLink" readonly />
      </div>
      <button class="btn btn-primary" id="copyBtn">Copy Link</button>
    </div>
  </div>

  <script>
  (function () {
    var TIMEZONES = [
      { group: "US", zones: [
        ["America/New_York", "Eastern Time (US & Canada)"],
        ["America/Chicago", "Central Time (US & Canada)"],
        ["America/Denver", "Mountain Time (US & Canada)"],
        ["America/Los_Angeles", "Pacific Time (US & Canada)"],
        ["America/Anchorage", "Alaska"],
        ["Pacific/Honolulu", "Hawaii"]
      ]},
      { group: "Canada", zones: [
        ["America/Halifax", "Atlantic Time (Canada)"],
        ["America/St_Johns", "Newfoundland"]
      ]},
      { group: "Central & South America", zones: [
        ["America/Mexico_City", "Mexico City"],
        ["America/Bogota", "Bogota"],
        ["America/Sao_Paulo", "Brasilia"],
        ["America/Argentina/Buenos_Aires", "Buenos Aires"],
        ["America/Santiago", "Santiago"]
      ]},
      { group: "Europe", zones: [
        ["Europe/London", "London (GMT/BST)"],
        ["Europe/Paris", "Paris, Berlin, Amsterdam (CET)"],
        ["Europe/Helsinki", "Helsinki, Bucharest (EET)"],
        ["Europe/Moscow", "Moscow"]
      ]},
      { group: "Africa", zones: [
        ["Africa/Cairo", "Cairo"],
        ["Africa/Lagos", "Lagos"],
        ["Africa/Johannesburg", "Johannesburg"]
      ]},
      { group: "Middle East", zones: [
        ["Asia/Dubai", "Dubai"],
        ["Asia/Riyadh", "Riyadh"],
        ["Asia/Jerusalem", "Jerusalem"]
      ]},
      { group: "Asia", zones: [
        ["Asia/Kolkata", "Mumbai, Kolkata, New Delhi"],
        ["Asia/Dhaka", "Dhaka"],
        ["Asia/Bangkok", "Bangkok, Hanoi, Jakarta"],
        ["Asia/Shanghai", "Beijing, Shanghai"],
        ["Asia/Hong_Kong", "Hong Kong"],
        ["Asia/Singapore", "Singapore"],
        ["Asia/Taipei", "Taipei"],
        ["Asia/Seoul", "Seoul"],
        ["Asia/Tokyo", "Tokyo, Osaka"]
      ]},
      { group: "Oceania", zones: [
        ["Australia/Perth", "Perth"],
        ["Australia/Sydney", "Sydney, Melbourne"],
        ["Pacific/Auckland", "Auckland, Wellington"]
      ]},
      { group: "Other", zones: [
        ["UTC", "UTC"]
      ]}
    ];

    var tzSelect = document.getElementById("tz");
    TIMEZONES.forEach(function (g) {
      var optgroup = document.createElement("optgroup");
      optgroup.label = g.group;
      g.zones.forEach(function (z) {
        var opt = document.createElement("option");
        opt.value = z[0];
        opt.textContent = z[1];
        optgroup.appendChild(opt);
      });
      tzSelect.appendChild(optgroup);
    });

    var slug = new URLSearchParams(window.location.search).get("slug") || "";
    if (!slug) { document.body.innerHTML = "<p>Missing slug.</p>"; return; }

    var origin = window.location.origin;
    var link = origin + "/book/" + slug;
    document.getElementById("bookingLink").value = link;

    // Try to auto-detect user timezone
    try {
      var detected = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (detected) tzSelect.value = detected;
    } catch (e) {}

    document.getElementById("copyBtn").addEventListener("click", function () {
      navigator.clipboard.writeText(link).then(function () {
        var b = document.getElementById("copyBtn");
        b.textContent = "Copied!";
        setTimeout(function () { b.textContent = "Copy Link"; }, 1500);
      });
    });

    fetch("/api/owner/" + slug).then(function (r) { return r.json(); }).then(function (d) {
      if (d.timezone) tzSelect.value = d.timezone;
      if (d.business_hours_start) document.getElementById("bhStart").value = d.business_hours_start;
      if (d.business_hours_end) document.getElementById("bhEnd").value = d.business_hours_end;
      if (d.slot_duration_minutes) document.getElementById("slotDur").value = d.slot_duration_minutes;
    });

    document.getElementById("saveBtn").addEventListener("click", function () {
      var msg = document.getElementById("statusMsg");
      fetch("/api/owner/" + slug + "/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          timezone: tzSelect.value,
          business_hours_start: document.getElementById("bhStart").value,
          business_hours_end: document.getElementById("bhEnd").value,
          slot_duration_minutes: parseInt(document.getElementById("slotDur").value),
        }),
      }).then(function (r) {
        if (!r.ok) throw new Error("Save failed");
        msg.textContent = "Settings saved!";
        msg.className = "status-msg success";
      }).catch(function (e) {
        msg.textContent = e.message;
        msg.className = "status-msg error";
      });
    });
  })();
  </script>
</body>
</html>
